pipeline {
    agent any
    
    
    
    environment {
        APP_URL = 'http://localhost:3000'
        HEADLESS = 'true'
        USE_LOCAL = 'true'
        EMAIL_RECIPIENTS = '${GIT_COMMITTER_EMAIL}, qasimmalik@gmail.com'
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
                sh '''
                    echo "üöÄ Starting MERN Memories Pipeline"
                    echo "Repository: ${GIT_URL}"
                    echo "Branch: ${GIT_BRANCH}"
                '''
            }
        }
        
        stage('Start MongoDB') {
            steps {
                sh '''
                    echo "üê≥ Starting MongoDB..."
                    docker run -d -p 27017:27017 --name mongo-memories mongo
                    sleep 5
                '''
            }
        }
        
        stage('Install Backend Dependencies') {
            steps {
                dir('backend') {
                    sh 'npm install'
                }
            }
        }
        
        stage('Start Backend Server') {
            steps {
                sh '''
                    cd backend
                    nohup npm start > backend.log 2>&1 &
                    echo "Backend started"
                    sleep 10
                '''
            }
        }
        
        stage('Install Frontend Dependencies') {
            steps {
                dir('frontend') {
                    sh 'npm install'
                }
            }
        }
        
        stage('Start Frontend Server') {
            steps {
                sh '''
                    cd frontend
                    nohup npm start > frontend.log 2>&1 &
                    echo "Frontend started"
                    sleep 15
                '''
            }
        }
        
        stage('Run Selenium Tests') {
            steps {
                dir('selenium-tests') {
                    sh '''
                        echo "üß™ Installing Python dependencies..."
                        pip install -r requirements.txt
                        echo "üß™ Running Selenium tests..."
                        python run_tests.py
                    '''
                }
            }
        }
        
        stage('Stop Servers') {
            steps {
                sh '''
                    echo "üßπ Cleaning up..."
                    pkill -f "node" || true
                    docker stop mongo-memories || true
                    docker rm mongo-memories || true
                '''
            }
        }
    }
    
    post {
        always {
            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'selenium-tests',
                reportFiles: 'test_report.html',
                reportName: 'Selenium Test Report'
            ])
            
            archiveArtifacts artifacts: 'selenium-tests/test_report.html, selenium-tests/screenshots/*.png', fingerprint: true
        }
        
        success {
            emailext(
                subject: "‚úÖ SUCCESS: MERN Memories Pipeline - Build #${BUILD_NUMBER}",
                body: """
                <h2>üéâ Pipeline Execution Successful!</h2>
                <p><strong>Project:</strong> MERN Memories Application</p>
                <p><strong>Build Number:</strong> ${BUILD_NUMBER}</p>
                <p><strong>Status:</strong> ${currentBuild.currentResult}</p>
                <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
                <p><strong>Test Report:</strong> <a href="${BUILD_URL}HTML_Report/">View HTML Report</a></p>
                <hr>
                <p><a href="${BUILD_URL}">View Build Details</a></p>
                """,
                to: '${GIT_COMMITTER_EMAIL}, qasimmalik@gmail.com',
                mimeType: 'text/html'
            )
        }
        
        failure {
            emailext(
                subject: "‚ùå FAILURE: MERN Memories Pipeline - Build #${BUILD_NUMBER}",
                body: """
                <h2>‚ö†Ô∏è Pipeline Execution Failed!</h2>
                <p><strong>Project:</strong> MERN Memories Application</p>
                <p><strong>Build Number:</strong> ${BUILD_NUMBER}</p>
                <p><strong>Status:</strong> ${currentBuild.currentResult}</p>
                <p><strong>Failed Stage:</strong> ${STAGE_NAME}</p>
                <p><strong>Test Report:</strong> <a href="${BUILD_URL}HTML_Report/">View HTML Report</a></p>
                <hr>
                <p><a href="${BUILD_URL}">View Build Details</a></p>
                <p><a href="${BUILD_URL}console">View Console Output</a></p>
                """,
                to: '${GIT_COMMITTER_EMAIL}, qasimmalik@gmail.com',
                mimeType: 'text/html'
            )
        }
    }
}